<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F3 AO Locations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 0;
        }

        .map-section {
            flex: 1;
            position: relative;
            background: white;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .location-header {
            display: none;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .location-header.active {
            display: flex;
        }

        .location-menu {
            position: relative;
        }

        .menu-button {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            transition: all 0.2s ease;
        }

        .menu-button:hover {
            background: #e0e0e0;
            color: #333;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 160px;
            z-index: 100;
            display: none;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background 0.2s ease;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item.danger {
            color: #f44336;
        }

        .menu-item.danger:hover {
            background: #fef2f2;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* Space for fixed footer */
        }

        .sidebar-header {
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px;
            z-index: 10;
            display: none;
        }

        .sidebar-header.active {
            display: block;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 16px;
            display: none;
        }

        .sidebar-footer.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            color: #999;
            margin-top: 60px;
            padding: 40px 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 16px;
            line-height: 1.5;
            color: #7f7f7f;
            margin-top: 24px;
        }

        .location-description {
            background: #f8f9ff;
            border: 1px solid #e3e8ff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .location-description h3 {
            font-size: 16px;
            color: #4c51bf;
            margin-bottom: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-description p {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
            margin: 0;
        }

        .location-form {
            display: none;
        }

        .location-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #7f7f7f;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .days-section {
            padding-top: 20px;
        }

        .days-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .day-item {
            margin-bottom: 8px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .day-item:hover {
            background: #f9f9f9;
            border-color: #2196F3;
        }

        .day-item-content {
            flex: 1;
        }

        .day-item-action {
            opacity: 0;
            color: #2196F3;
            font-size: 12px;
            font-weight: 600;
            transition: opacity 0.2s ease;
            margin-left: 12px;
        }

        .day-item:hover .day-item-action {
            opacity: 1;
        }

        .day-item.empty {
            opacity: 0.6;
        }

        .day-item.filled {
            background: #f0f7ff;
            border-color: #2196F3;
        }

        .day-item.empty {
            opacity: 0.6;
        }

        .day-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .day-content {
            font-size: 12px;
            color: #666;
        }

        .ao-name {
            font-weight: 600;
            color: #2196F3;
        }

        .time-range {
            color: #999;
            font-size: 11px;
        }

        .edit-day-form {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 4px;
            border: 1px solid #2196F3;
        }

        .edit-day-form.active {
            display: block;
        }

        .edit-day-form h4 {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 14px;
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .button-group button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-save {
            background: #2196F3;
            color: white;
        }

        .btn-save:hover {
            background: #1976D2;
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
        }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .back-button {
            margin-bottom: 0;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: #efefef;
            border-color: #999;
        }

        .marker-container {
            display: flex;
            gap: 2px;
            background: white;
            padding: 3px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
            position: relative;
            width: fit-content;
        }

        .marker-container::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid white;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.2s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .modal-description {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-content {
            margin-bottom: 24px;
        }


        .day-indicator {
            padding: 3px 4px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            min-width: 22px;
            line-height: 1.2;
        }

        .day-indicator.monday {
            background: #ff6b6b;
            color: white;
        }

        .day-indicator.tuesday {
            background: #4ecdc4;
            color: white;
        }

        .day-indicator.wednesday {
            background: #45b7d1;
            color: white;
        }

        .day-indicator.thursday {
            background: #96ceb4;
            color: white;
        }

        .day-indicator.friday {
            background: #feca57;
            color: white;
        }

        .day-indicator.saturday {
            background: #ff9ff3;
            color: white;
        }

        #map {
            cursor: crosshair;
        }

        /* Toast Styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #2196F3;
            min-width: 300px;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.success {
            border-left-color: #4caf50;
        }

        .toast-message {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            line-height: 1.4;
        }

        /* Confirm Dialog Styles */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: confirmSlideIn 0.2s ease-out;
        }

        @keyframes confirmSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .confirm-header {
            margin-bottom: 16px;
        }

        .confirm-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .confirm-message {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .confirm-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirm-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .confirm-cancel:hover {
            background: #e0e0e0;
        }

        .confirm-confirm {
            background: #f44336;
            color: white;
        }

        .confirm-confirm:hover {
            background: #d32f2f;
        }

        /* Input Dialog Styles */
        .input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .input-overlay.active {
            display: flex;
        }

        .input-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: inputSlideIn 0.2s ease-out;
        }

        @keyframes inputSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .input-header {
            margin-bottom: 16px;
        }

        .input-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
        }

        .input-message {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 24px;
            transition: border-color 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #2196F3;
        }

        .input-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .input-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .input-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .input-cancel:hover {
            background: #e0e0e0;
        }

        .input-submit {
            background: #2196F3;
            color: white;
        }

        .input-submit:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-section">
            <div id="map"></div>
        </div>
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="location-header">
                    <button class="back-button" onclick="app.backToList()">← Back to Locations</button>
                    <div class="location-menu">
                        <button class="menu-button" onclick="app.toggleLocationMenu()" type="button">⋯</button>
                        <div class="menu-dropdown" id="locationMenu">
                            <button class="menu-item danger" onclick="app.deleteLocation()" type="button">Delete Location</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="empty-state" id="emptyState">
                    <h3>Welcome to F3 Locations</h3>
                    <p>Click on any colored marker on the map to view workout schedules and meeting details for that location. Each marker shows which days have scheduled workouts.</p>
                    <p>Click anywhere on the map to add a new location.</p>
                </div>
                <form class="location-form" id="locationForm" onsubmit="app.saveLocation(event)">
                    <div class="days-section">
                        <h3>Meeting Location</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 16px;">This is the physical location where PAX gather for workouts, not necessarily the same name as the AO. The coordinates below show the exact meeting spot on the map.</p>
                    </div>
                    <div class="form-group">
                        <label>Location Name</label>
                        <input type="text" id="locationName" required>
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="latitude" step="0.0001" required readonly>
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="longitude" step="0.0001" required readonly>
                    </div>

                    <div class="days-section">
                        <h3>Weekly Schedule</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 16px;">Click any day to add or edit workout times. Days with workouts will show in color on the map marker.</p>
                        <div id="daysList"></div>
                    </div>


                </form>
            </div>
            <div class="sidebar-footer" id="sidebarFooter">
                <div class="button-group">
                    <button type="button" class="btn-save" onclick="app.saveLocationFromFooter()">Save Location</button>
                    <button type="button" class="btn-cancel" onclick="app.cancelEdit()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Edit Modal -->
    <div class="modal-overlay" id="dayEditModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalDayLabel">Edit Monday</h3>
                <p class="modal-description" id="modalDescription">Set up the workout details for this day</p>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label>AO Name</label>
                    <input type="text" id="modalAoName" placeholder="e.g., The Bleach, The Shoal, The Warm Up">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="modalStartTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="modalEndTime">
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-save" onclick="app.saveModalDayTime()">Save</button>
                <button type="button" class="btn-delete" onclick="app.deleteModalTime()" id="modalDeleteBtn">Delete</button>
                <button type="button" class="btn-cancel" onclick="app.closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confirm Dialog -->
    <div class="confirm-overlay" id="confirmDialog">
        <div class="confirm-dialog">
            <div class="confirm-header">
                <h3 id="confirmTitle">Confirm Action</h3>
            </div>
            <div class="confirm-message" id="confirmMessage">
                Are you sure you want to proceed?
            </div>
            <div class="confirm-buttons">
                <button class="confirm-cancel" onclick="app.closeConfirm()">Cancel</button>
                <button class="confirm-confirm" id="confirmButton" onclick="app.confirmAction()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Input Dialog -->
    <div class="input-overlay" id="inputDialog">
        <div class="input-dialog">
            <div class="input-header">
                <h3 id="inputTitle">Input Required</h3>
                <div class="input-message" id="inputMessage">Please enter a value:</div>
            </div>
            <input type="text" class="input-field" id="inputField" placeholder="Enter value">
            <div class="input-buttons">
                <button class="input-cancel" onclick="app.closeInput()">Cancel</button>
                <button class="input-submit" onclick="app.submitInput()">Add</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        const app = {
            map: null,
            markers: {},
            currentLocation: null,
            editingDay: null,
            
            // Load locations from localStorage or use defaults
            locations: JSON.parse(localStorage.getItem('f3-locations')) || [
                {
                    id: 1,
                    name: 'Borah Park',
                    lat: 43.6150,
                    lng: -116.2023,
                    times: {
                        0: null,
                        1: { name: 'Bleach', start: '05:15', end: '06:00' },
                        2: null,
                        3: { name: 'Bleach', start: '05:15', end: '06:00' },
                        4: null,
                        5: null,
                        6: { name: 'Bleach', start: '06:00', end: '07:00' }
                    }
                },
                {
                    id: 2,
                    name: 'Barber Park',
                    lat: 43.4743,
                    lng: -116.3213,
                    times: {
                        0: null,
                        1: null,
                        2: { name: 'The Shoal', start: '05:30', end: '06:15' },
                        3: null,
                        4: { name: 'The Shoal', start: '05:30', end: '06:15' },
                        5: null,
                        6: { name: 'The Shoal', start: '05:30', end: '06:15' }
                    }
                },
                {
                    id: 3,
                    name: 'Camel\'s Back Park',
                    lat: 43.6413,
                    lng: -116.2412,
                    times: {
                        0: null,
                        1: null,
                        2: { name: 'The Warm Up', start: '06:00', end: '06:45' },
                        3: null,
                        4: { name: 'The Warm Up', start: '06:00', end: '06:45' },
                        5: null,
                        6: null
                    }
                },
                {
                    id: 4,
                    name: 'Boise Foothills',
                    lat: 43.6800,
                    lng: -116.1500,
                    times: {
                        0: null,
                        1: { name: 'Tower', start: '06:00', end: '06:45' },
                        2: null,
                        3: null,
                        4: null,
                        5: { name: 'Tower', start: '06:00', end: '06:45' },
                        6: null
                    }
                }
            ],

            init() {
                this.initMap();
                this.renderMarkers();
            },

            saveToLocalStorage() {
                localStorage.setItem('f3-locations', JSON.stringify(this.locations));
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                toast.innerHTML = `<div class="toast-message">${message}</div>`;
                
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 10);
                
                // Auto remove after 4 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => container.removeChild(toast), 300);
                }, 4000);
            },

            showConfirm(title, message, confirmText = 'Confirm', callback = null) {
                this.confirmCallback = callback;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmButton').textContent = confirmText;
                document.getElementById('confirmDialog').classList.add('active');
            },

            closeConfirm() {
                document.getElementById('confirmDialog').classList.remove('active');
                this.confirmCallback = null;
            },

            confirmAction() {
                if (this.confirmCallback) {
                    this.confirmCallback();
                }
                this.closeConfirm();
            },

            showInputDialog(title, message, placeholder, callback) {
                this.inputCallback = callback;
                document.getElementById('inputTitle').textContent = title;
                document.getElementById('inputMessage').textContent = message;
                document.getElementById('inputField').placeholder = placeholder;
                document.getElementById('inputField').value = '';
                document.getElementById('inputDialog').classList.add('active');
                
                // Auto-focus the input field
                setTimeout(() => {
                    document.getElementById('inputField').focus();
                }, 100);
            },

            closeInput() {
                document.getElementById('inputDialog').classList.remove('active');
                this.inputCallback = null;
            },

            submitInput() {
                const value = document.getElementById('inputField').value;
                if (this.inputCallback) {
                    this.inputCallback(value);
                }
                this.closeInput();
            },

            toggleLocationMenu() {
                const menu = document.getElementById('locationMenu');
                menu.classList.toggle('active');
            },

            deleteLocation() {
                this.toggleLocationMenu(); // Close menu first
                
                this.showConfirm(
                    'Delete Location',
                    `Are you sure you want to delete "${this.currentLocation.name}" and all its workout schedules? This action cannot be undone.`,
                    'Delete',
                    () => {
                        const locationId = this.currentLocation.id;
                        
                        // Remove marker from map
                        if (this.markers[locationId]) {
                            this.map.removeLayer(this.markers[locationId]);
                            delete this.markers[locationId];
                        }
                        
                        // Remove from locations array
                        this.locations = this.locations.filter(loc => loc.id !== locationId);
                        
                        // Save to localStorage
                        this.saveToLocalStorage();
                        
                        // Go back to empty state
                        this.cancelEdit();
                        
                        this.showToast('Location deleted successfully', 'success');
                    }
                );
            },

            initMap() {
                this.map = L.map('map').setView([43.5400, -116.2600], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(this.map);

                // Add click handler for adding new locations
                this.map.on('click', (e) => {
                    this.addNewLocation(e.latlng.lat, e.latlng.lng);
                });
            },


            addNewLocation(lat, lng) {
                this.showInputDialog(
                    'Add New Location',
                    'Enter the name of the physical meeting location (e.g., "Borah Park", "Barber Park"). This is where PAX gather for workouts, not necessarily the same name as the AO (though it can be).',
                    'e.g., Central Park, City Hall, etc.',
                    (name) => {
                        if (!name || !name.trim()) {
                            this.showToast('Location name is required', 'error');
                            return;
                        }

                        // Create new location with empty times
                        const newLocation = {
                            id: Date.now(), // Simple ID generation
                            name: name.trim(),
                            lat: parseFloat(lat.toFixed(4)),
                            lng: parseFloat(lng.toFixed(4)),
                            times: {
                                0: null, // Sunday
                                1: null, // Monday
                                2: null, // Tuesday
                                3: null, // Wednesday
                                4: null, // Thursday
                                5: null, // Friday
                                6: null  // Saturday
                            }
                        };

                        // Add to locations array
                        this.locations.push(newLocation);
                        
                        // Save to localStorage
                        this.saveToLocalStorage();
                        
                        // Re-render markers
                        this.renderMarkers();
                        
                        // Auto-select the new location
                        this.selectLocation(newLocation);
                        
                        this.showToast('Location added successfully', 'success');
                    }
                );
            },

            getMarkerHTML(location) {
                const days = location.times;
                const dayNames = ['Su', 'M', 'Tu', 'W', 'Th', 'F', 'Sa'];
                const dayClasses = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                
                let dayIndicators = '';
                
                // Check each day and create indicators for active days
                for (let i = 1; i <= 6; i++) { // Skip Sunday (index 0) for now
                    if (days[i]) {
                        dayIndicators += `<div class="day-indicator ${dayClasses[i]}">${dayNames[i]}</div>`;
                    }
                }
                
                // If no weekdays, check Sunday
                if (!dayIndicators && days[0]) {
                    dayIndicators = `<div class="day-indicator ${dayClasses[0]}">${dayNames[0]}</div>`;
                }
                
                // If still no indicators, show a question mark
                if (!dayIndicators) {
                    dayIndicators = '<div class="day-indicator" style="background: #ccc; color: #666;">?</div>';
                }
                
                return `<div class="marker-container">${dayIndicators}</div>`;
            },

            renderMarkers() {
                this.locations.forEach(location => {
                    if (this.markers[location.id]) {
                        this.map.removeLayer(this.markers[location.id]);
                    }

                    const html = this.getMarkerHTML(location);
                    
                    // Count active days to determine marker width
                    const activeDays = Object.values(location.times).filter(time => time !== null).length;
                    const markerWidth = Math.max(30, activeDays * 20 + 10); // Minimum 30px, then 20px per day + 10px padding
                    const markerHeight = 30; // Fixed height

                    const marker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            html: html,
                            className: '',
                            iconSize: [markerWidth, markerHeight],
                            iconAnchor: [markerWidth / 2, markerHeight + 6] // Anchor at the bottom point of the pin
                        })
                    }).addTo(this.map);

                    marker.on('click', () => this.selectLocation(location));
                    this.markers[location.id] = marker;
                });
            },

            selectLocation(location) {
                this.currentLocation = location;
                this.editingDay = null;
                this.closeModal();
                this.renderLocationForm();
            },

            renderLocationForm() {
                const location = this.currentLocation;
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('locationForm').classList.add('active');
                document.querySelector('.sidebar-header').classList.add('active');
                document.querySelector('.location-header').classList.add('active');
                document.getElementById('sidebarFooter').classList.add('active');

                document.getElementById('locationName').value = location.name;
                document.getElementById('latitude').value = location.lat;
                document.getElementById('longitude').value = location.lng;

                this.renderDaysList();
            },

            renderDaysList() {
                const location = this.currentLocation;
                const daysList = document.getElementById('daysList');
                daysList.innerHTML = '';

                DAYS.forEach((day, index) => {
                    const time = location.times[index];
                    const dayItem = document.createElement('div');
                    dayItem.className = `day-item ${time ? 'filled' : 'empty'}`;
                    dayItem.onclick = () => this.editDay(index);

                    const actionText = time ? 'Edit' : 'Add';

                    if (time) {
                        dayItem.innerHTML = `
                            <div class="day-item-content">
                                <div class="day-label">${day}</div>
                                <div class="day-content">
                                    <div class="ao-name">${time.name}</div>
                                    <div class="time-range">${time.start} – ${time.end}</div>
                                </div>
                            </div>
                            <div class="day-item-action">${actionText}</div>
                        `;
                    } else {
                        dayItem.innerHTML = `
                            <div class="day-item-content">
                                <div class="day-label">${day}</div>
                                <div class="day-content">No time scheduled</div>
                            </div>
                            <div class="day-item-action">${actionText}</div>
                        `;
                    }

                    daysList.appendChild(dayItem);
                });
            },

            editDay(dayIndex) {
                this.editingDay = dayIndex;
                const location = this.currentLocation;
                const time = location.times[dayIndex];
                const isEditing = !!time;

                document.getElementById('modalDayLabel').textContent = `${isEditing ? 'Edit' : 'Add'} ${DAYS[dayIndex]} Workout`;
                
                const description = isEditing 
                    ? `Update the workout details for ${DAYS[dayIndex]} at ${location.name}`
                    : `Add a new workout schedule for ${DAYS[dayIndex]} at ${location.name}`;
                document.getElementById('modalDescription').textContent = description;
                
                document.getElementById('dayEditModal').classList.add('active');

                if (time) {
                    document.getElementById('modalAoName').value = time.name;
                    document.getElementById('modalStartTime').value = time.start;
                    document.getElementById('modalEndTime').value = time.end;
                    document.getElementById('modalDeleteBtn').style.display = 'inline-block';
                } else {
                    // Smart defaults for new days
                    const defaults = this.getSmartDefaults(location, dayIndex);
                    document.getElementById('modalAoName').value = defaults.name;
                    document.getElementById('modalStartTime').value = defaults.start;
                    document.getElementById('modalEndTime').value = defaults.end;
                    document.getElementById('modalDeleteBtn').style.display = 'none';
                }

                // Auto-focus the first input after modal animation
                setTimeout(() => {
                    document.getElementById('modalAoName').focus();
                }, 250);
            },

            getSmartDefaults(location, dayIndex) {
                // First, check if this location has other days with times
                const existingTimes = Object.values(location.times).filter(t => t !== null);
                
                if (existingTimes.length > 0) {
                    // Use existing times from this location
                    return this.getDefaultsFromLocation(existingTimes);
                } else {
                    // New location - use regional defaults for this day
                    return this.getRegionalDefaults(dayIndex);
                }
            },

            getDefaultsFromLocation(existingTimes) {
                // Check if all existing times have the same AO name
                const names = existingTimes.map(t => t.name);
                const uniqueNames = [...new Set(names)];
                const defaultName = uniqueNames.length === 1 ? uniqueNames[0] : '';

                // Use the most common start/end times
                const startTimes = existingTimes.map(t => t.start);
                const endTimes = existingTimes.map(t => t.end);
                
                const defaultStart = this.getMostCommon(startTimes);
                const defaultEnd = this.getMostCommon(endTimes);

                return {
                    name: defaultName,
                    start: defaultStart,
                    end: defaultEnd
                };
            },

            getRegionalDefaults(dayIndex) {
                // Collect all times for this day across all locations
                const dayTimes = [];
                this.locations.forEach(loc => {
                    if (loc.times[dayIndex]) {
                        dayTimes.push(loc.times[dayIndex]);
                    }
                });

                if (dayTimes.length === 0) {
                    // No regional data, use F3 typical defaults
                    return {
                        name: '',
                        start: '05:30',
                        end: '06:15'
                    };
                }

                // Use most common times from the region for this day
                const startTimes = dayTimes.map(t => t.start);
                const endTimes = dayTimes.map(t => t.end);

                return {
                    name: '', // Don't suggest AO names from other locations
                    start: this.getMostCommon(startTimes),
                    end: this.getMostCommon(endTimes)
                };
            },

            getMostCommon(arr) {
                if (arr.length === 0) return '';
                
                const frequency = {};
                arr.forEach(item => {
                    frequency[item] = (frequency[item] || 0) + 1;
                });

                return Object.keys(frequency).reduce((a, b) => 
                    frequency[a] > frequency[b] ? a : b
                );
            },

            saveModalDayTime() {
                const location = this.currentLocation;
                const name = document.getElementById('modalAoName').value.trim();
                const start = document.getElementById('modalStartTime').value;
                const end = document.getElementById('modalEndTime').value;

                // If all fields are empty, remove the time
                if (!name && !start && !end) {
                    location.times[this.editingDay] = null;
                    this.showToast('Workout time removed', 'success');
                } else {
                    // Otherwise, require all fields to be filled
                    if (!name || !start || !end) {
                        this.showToast('Please fill in all fields or leave all empty to remove the time', 'error');
                        return;
                    }
                    location.times[this.editingDay] = { name, start, end };
                    this.showToast('Workout time saved', 'success');
                }

                this.closeModal();
                this.renderDaysList();
                this.renderMarkers();
                this.saveToLocalStorage();
            },

            deleteModalTime() {
                this.showConfirm(
                    'Delete Workout Time',
                    `Are you sure you want to delete the ${DAYS[this.editingDay]} workout time?`,
                    'Delete',
                    () => {
                        this.currentLocation.times[this.editingDay] = null;
                        this.closeModal();
                        this.renderDaysList();
                        this.renderMarkers();
                        this.saveToLocalStorage();
                        this.showToast('Workout time deleted', 'success');
                    }
                );
            },

            closeModal() {
                this.editingDay = null;
                document.getElementById('dayEditModal').classList.remove('active');
            },

            saveLocation(e) {
                e.preventDefault();
                const name = document.getElementById('locationName').value.trim();

                if (!name) {
                    this.showToast('Location name is required', 'error');
                    return;
                }

                this.currentLocation.name = name;
                this.renderMarkers();
                this.saveToLocalStorage();
                this.showToast('Location updated', 'success');
                this.cancelEdit();
            },

            cancelEdit() {
                this.currentLocation = null;
                this.editingDay = null;
                document.getElementById('locationForm').classList.remove('active');
                document.querySelector('.sidebar-header').classList.remove('active');
                document.querySelector('.location-header').classList.remove('active');
                document.getElementById('sidebarFooter').classList.remove('active');
                document.getElementById('emptyState').style.display = 'block';
                this.closeModal();
            },

            saveLocationFromFooter() {
                // Trigger the form submission
                const form = document.getElementById('locationForm');
                const event = new Event('submit', { cancelable: true });
                form.dispatchEvent(event);
            },

            backToList() {
                this.cancelEdit();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            // Close modal when clicking outside
            document.getElementById('dayEditModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    app.closeModal();
                }
            });

            // Close confirm dialog when clicking outside
            document.getElementById('confirmDialog').addEventListener('click', (e) => {
                if (e.target.classList.contains('confirm-overlay')) {
                    app.closeConfirm();
                }
            });

            // Close input dialog when clicking outside
            document.getElementById('inputDialog').addEventListener('click', (e) => {
                if (e.target.classList.contains('input-overlay')) {
                    app.closeInput();
                }
            });

            // Handle Enter key in input dialog
            document.getElementById('inputField').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    app.submitInput();
                }
            });

            // Close location menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('locationMenu');
                const button = e.target.closest('.menu-button');
                
                if (!button && !e.target.closest('.menu-dropdown')) {
                    menu.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
