# F3 Beatdown Import Script

This script imports F3 workout location and event data from the F3 Nation API into Firestore.

## Prerequisites

1. Node.js (v14 or later)
2. Firebase Admin SDK credentials
3. Access to the F3 Nation API endpoints

## Setup

1. Install dependencies:
   ```bash
   npm install
   ```

2. Set up Firebase Admin credentials:
   - Place your Firebase Admin SDK service account key JSON file in the `functions/scripts` directory
   - Rename it to `service-account.json`

3. Set up API credentials (required):
   - Copy `.env.example` to `.env`:
     ```bash
     cp .env.example .env
     ```
   - Edit `.env` and add your F3 Nation API key:
     ```
     F3_API_KEY=your_api_key_here
     F3_CLIENT=f3nearme
     ```
   - The `.env` file is gitignored and will not be committed
   - Alternatively, you can set environment variables:
     ```bash
     export F3_API_KEY="your_api_key_here"
     export F3_CLIENT="f3nearme"
     ```

## Usage

### Dry Run (Recommended First)
Test the sync without making any changes to Firestore:
```bash
npm run sync:dry-run
```
This will:
- Fetch all events and locations from the API
- Show what would be created, updated, or deleted
- Display statistics without making any changes
- Help you verify the sync will work correctly

### Full Sync
Run the actual sync to import/update beatdowns:
```bash
npm run sync
```
or
```bash
npm start
```

### Cleanup Only Mode
To only delete beatdowns that no longer exist in the API (without syncing):
```bash
npm run cleanup
```
or with dry run:
```bash
npm run cleanup:dry-run
```
This will:
- Fetch all events and locations from the API
- Generate valid beatdown IDs from current API data
- Compare with existing beatdowns in Firestore
- Delete only the beatdowns that no longer exist in the API
- **Does not** create or update any beatdowns

### Analysis Mode
To analyze location changes without performing a full sync:
```bash
npm run analyze
```
This will:
- Compare existing locations in the database with the API
- Show which locations have been added or deleted
- Display statistics about new and updated beatdowns
- Only process new locations (not a full sync)

### Cleanup Mode
The script includes an optional cleanup feature that can be enabled by setting `OPTIONAL_CLEANUP = true` in the script. When enabled, it will:
- Remove any beatdowns that no longer exist in the API
- Only run during the full import (not in analysis mode)

## Features

- Retries failed API requests (3 attempts with exponential backoff)
- Processes locations in batches to avoid rate limiting
- Uses Firestore batch writes for efficient data storage
- Provides detailed logging of the import process
- TypeScript for type safety and better development experience
- Analysis mode for previewing changes
- Optional cleanup of obsolete beatdowns

## Error Handling

- Failed API requests are retried up to 3 times
- Individual location failures are logged but don't stop the entire import
- The script will exit with an error code if the initial data fetch fails

## Output

The script will create documents in the `beatdowns` collection in Firestore with the following structure:

```typescript
interface Beatdown {
  dayOfWeek: string;      // e.g., "monday", "wednesday"
  timeString: string;     // e.g., "5:15 am - 6:00 am"
  type: string;          // e.g., "Bootcamp", "Ruck"
  region: string;        // Region name
  website: string;       // Website URL
  notes: string;         // Description
  name: string;          // Location name
  address: string;       // Full address
  lat: number;          // Latitude
  long: number;         // Longitude
  locationId: number;   // Original location ID from API
  eventId: number;      // Original event ID from API
}
```

## Document IDs

Each beatdown document is assigned a unique ID based on:
- Region name
- Beatdown name
- Day of week

The ID is generated by converting these values to lowercase and replacing spaces/special characters with hyphens. 